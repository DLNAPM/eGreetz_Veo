rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Rules for individual greeting productions (My Productions)
    match /greetings/{greetingId} {
      // Allow anyone to 'get' a single document by ID to support Public Viewer Mode (?v=ID)
      allow get: if true;
      
      // Allow users to list (query) only the documents they created
      allow list: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Allow any authenticated user to create a greeting
      allow create: if request.auth != null;
      
      // Only the owner can update or delete their production
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Rules for greetings shared between users (Inbox / Shared with Me)
    match /shared_greetings/{shareId} {
      // Allow anyone to 'get' a single shared document by ID to support Public Shared Viewer Mode (?s=ID)
      allow get: if true;
      
      // Allow users to list (query) greetings shared specifically WITH them based on their Google Email
      allow list: if request.auth != null && 
                  request.auth.token.email.toLowerCase() == resource.data.recipientEmail.toLowerCase();
      
      // Allow any authenticated user to create a share record (sending to someone)
      allow create: if request.auth != null;
      
      // Only the recipient can delete a shared record from their inbox
      allow delete: if request.auth != null && 
                    request.auth.token.email.toLowerCase() == resource.data.recipientEmail.toLowerCase();
    }
  }
}